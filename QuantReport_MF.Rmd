---
title: "市场观察"
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output: 
  html_document:
    toc: true # table of content true
    depth: 3  # upto three depths of headings (specified by #, ## and ###)
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo=FALSE)
suppressMessages(source('rpt_data_package.R', encoding = 'UTF-8'))
```


## A、指数估值
### (a)动态市盈率、市净率
核心指数成分股近18个月的动态市盈率及动态市净率中位数走势如下图所示：

```{r indexValue,warning=FALSE}
suppressMessages(source('rpt_index_valuation.R', encoding = 'UTF-8'))
valuets.v <- valuets[,c("date","indexName","PE_median","PB_median")]
p1 <- ggplot(valuets.v, aes(x=date, y=PE_median,color=indexName)) + geom_line()
p2 <- ggplot(valuets.v, aes(x=date, y=PB_median,color=indexName)) + geom_line()
multiplot(p1, p2, ncol=1)
```

### (b)动态市盈率、市净率百分位
核心指数近18个月的动态市盈率百分位及动态市净率百分位走势如下图所示：

```{r indexValuePer,warning=FALSE}
valuets.p <- valuets[,c("date","indexName","perPE","perPB")]
valuets.p <- reshape2::melt(valuets.p,id=c("date","indexName"))
ggplot(valuets.p, aes(x=date, y=value,color=indexName))+geom_line()+facet_grid(variable~.)
```

### (c)指数估值概览
纳入观察的18只指数最新的估值情况如下表，根据市盈率和市净率分位数均值降序排列。
   
```{r indexValuetable,results='asis'}
kable(tablevaluation)
```


### (d)另类估值
我国10年期国债收益率、金银比价、金油比价，2000年以来的历史百分位如下图所示：
   
```{r sepcialvaluation}
ggplot.ts.line(value.all)
```


**************************************************************************
    
    
**************************************************************************

## B、基差
### (a)基差走势
三大股指期货合约基差走势如下图，其中当月合约和次月合约年化基差百分比波动较大，仅展示合约基差百分比，当季合约和次季合约展示基差年化百分比：
   
```{r spreadts,warning=FALSE}
source('rpt_IF_spread.R', encoding = 'UTF-8')
tmp <- spreadts[spreadts$stockIDCon %in% c('IC0Y00','IH0Y00','IF0Y00'),]
p1 <- ggplot(tmp, aes(x=date, y=spreadPct,color=ConName))+geom_line()
tmp <- spreadts[spreadts$stockIDCon %in% c('IC0Y01','IH0Y01','IF0Y01'),]
p2 <- ggplot(tmp, aes(x=date, y=spreadPct,color=ConName))+geom_line()
tmp <- spreadts[spreadts$stockIDCon %in% c('IC0Y02','IH0Y02','IF0Y02'),]
p3 <- ggplot(tmp, aes(x=date, y=spreadPctAna,color=ConName))+geom_line()
tmp <- spreadts[spreadts$stockIDCon %in% c('IC0Y03','IH0Y03','IF0Y03'),]
p4 <- ggplot(tmp, aes(x=date, y=spreadPctAna,color=ConName))+geom_line()
multiplot(p1,p2,p3,p4,ncol=1)
```
  
### (b)基差概况
三大股指期货连续合约基差概况如下表，近月合约临近到期日，年化基差百分比数据波动较大：
    
```{r spreadinfo,results='asis'}
kable(spreadinfo)
```


**************************************************************************
    
    
**************************************************************************

## C、套利和事件
### (a)复牌股票套利
近两天复牌股票套利情况如下表：
    
```{r resumeStock,results='asis'}
source('rpt_event_arbitrage.R', encoding = 'UTF-8')
if(is.character(resumeStock)){
  print('无复牌股票套利')
}else{
  kable(resumeStock)
}

```

    
### (b)定增基金(provided by han.qian)
截止`r Sys.Date()`定增基金数据如下表，明细数据参见钱瀚的模板。
    
```{r privateOffering,results='asis'}
privateOffering <- read.csv("privateOffering.csv", stringsAsFactors=FALSE)
privateOffering[,4] <- round(privateOffering[,4],2)
privateOffering[,5] <- round(privateOffering[,5],2)
privateOffering[,6] <- scales::percent(round(privateOffering[,6],3))
privateOffering[,7] <- scales::percent(round(privateOffering[,7],3))
privateOffering[,8] <- scales::percent(round(privateOffering[,8],3))
kable(privateOffering)
```
   
   
定增基金近期的净值走势如下图：
    
```{r ponav,warning=FALSE}
fundID <- substr(privateOffering[,1],1,6)
endT <- Sys.Date()
begT <- trday.offset(endT,by = months(-3))
pofund <- POFund(fundID,begT,endT)
pofund$pre <- pofund$pre*100
ggplot(pofund, aes(x=date, y=NAV,color=fundName))+geom_line()
```

    
定增基金近期的折溢价率百分比走势如下图：
    
```{r popre,warning=FALSE}
ggplot(pofund, aes(x=date, y=pre,color=fundName))+geom_line()
```


### (c)定增解禁(provided by han.qian)
近十天定增解禁的股票情况如下表。
```{r unfrozenStock,results='asis'}
kable(unfroz)
```

      

### (d)中小板业绩预增预测(provided by han.qian)
中小板规定正式财务报告发布的同时需要发布新一期的业绩预报，比如年报中会包含一季报预告的情况。我们假设公司的盈利状况有动量效应，年报预增的公司一季度也会预增，在正式财务报告发布前20个交易日开始埋伏，然后等正式报告发布日卖出。具体研究参见钱瀚前期的研究。需要注意的是这里的收益率仅做展示，仅仅是每日全部入选股票的平均收益率，并没有做成一个事件组合。
    
```{r middlesmall}
multiplot(ggplot.WealthIndex(midsmallsector.rtn),ggplot.ts.bar(midsmallsector.port))
```
    

历年收益统计如下表所示。
    
```{r middlesmalltable,results='asis'}
kable(midsmall.rtntable)
```

**************************************************************************
    
    
**************************************************************************

## D、择时


### (a)等权指数
从历史来看，A股市场存在小盘股效应，市值小的股票长期整体跑赢大市值的股票，美股市场同样存在类似的现象。而目前大部分指数的编制方案都是类似市值加权，为了抛去市值的影响，下面展示几个等权指数，其中中证500等权和沪深300等权是现有的指数，中证全指等权是自己编制的指数。等权指数可以视为一个更好地业绩比较基准。等权指数走势如下图： 
    
```{r ewMarketplot}
source("rpt_timing.R", encoding = 'UTF-8')
ggplot.ts.line(ewMarketts)
```   
   
等权指数收益率统计见下表：   
   
```{r ewMarkettable,results='asis'}
kable(ewMarketSum)
```      
   


### (b)大盘均线强弱指数
大盘均线强弱指数在一定程度上可以视为一个反转指标，当大盘均线得分接近8分时，预示市场接近顶部，当大盘均线得分接近0分时，预示市场接近底部。    
大盘均线强弱指数近一年来走势如下图： 
    
```{r indexMAplot}
ggplot.ts.line(indexScorets)
```   
   
申万一级行业的最新得分见下表：   
   
```{r indexMAtable,results='asis'}
kable(indexScoreData)
```      
   

### (c)LLT及均线择时
LLT本质上是一个改进的单均线择时指标，较原始的均线择时延迟更低。   
择时模型和指数本身的净值走势如下图：

```{r timingplot,warning=FALSE}
ggplot.ts.line(allwealth)
```
   
   
择时模型和指数的收益率统计如下表：
    
```{r timingsum,results='asis'}
kable(allsum)
```

   
择时模型最近10个交易日的信号如下表：

```{r timingsignal,results='asis'}
kable(signal)
```  

  
    
### (d)网格交易
在经历了三轮股灾，A股逐步回归正常，在过去的一段时间呈现一个震荡的格局，如果未来没有增量信息，很可能维持震荡。结合股指期货的贴水，前期研究了一下网格交易。网格交易的结果如下图：

```{r gridwealth,warning=FALSE}
ggplot.ts.line(gridWealth)
```

    
网格交易沪深300股指期货的最新仓位是`r scales::percent(last(gridIF300$mv/gridIF300$totalasset))`，中证500股指期货的最新仓位是`r scales::percent(last(gridIF500$mv/gridIF500$totalasset))`,网格交易的收益统计如下表：
    
```{r gridSum,results='asis'}
kable(gridsum)
```
    


      
**************************************************************************
    
    
**************************************************************************

## E、选股


### (a)超级小盘股
作为多因子选股的第一部分，有必要从市值因子说起。
下面利用总市值因子，在中证全指的成分股内，选出市值最小的100只股票，这里剔除了ST、新上市、停牌和涨停的股票，100只股票等权配置，每月换仓一次，交易成本千分之三。超级小盘股策略的净值表现如下图。

```{r supersmallplot,warning=FALSE}
source("rpt_pick_stock.R", encoding = 'UTF-8')
ggplot.WealthIndex(smallStockRtn)
```
    

超级小盘股的收益统计如下表：
    
```{r supersmalltable,results='asis'}
kable(allsmallstockrtnSum)
```



### (b)银行股轮动
银行股轮动是参考集思录的热门贴银行股评级而来的，数据的提取和参数的设置和原贴有一定的差别，所以轮动的效果也会不太一样，不过回测的效果还不错，从现在开始跟踪。2013年以来银行股轮动的结果如下图：
    

```{r bankplot,warning=FALSE}
ggplot.WealthIndex(bankrtn)
```
    

银行股轮动的收益统计如下表：
    
```{r banksum,results='asis'}
kable(bankrtnsum)
```
    
  
银行股轮动的最新得分如下表：
    
```{r banknew,results='asis'}
kable(banknew)
```      
    


## F、多因子跟踪
### (a)近一个月周频因子IC
```{r mf_load_data,include=FALSE}
source("rpt_factor_model.R", encoding = 'UTF-8')
```



全市场因子IC表现如下图所示。
     
     
```{r,IC_week_all,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ic_week_all %>% filter(indexID=='EI000985') %>% group_by(date, fname) %>%  arrange(IC) %>% ungroup() %>%
  mutate(fname = factor(paste(fname, date, sep = "TMPxxx"), levels = rev(paste(fname,date, sep = "TMPxxx"))))

ggplot(tmp,aes(fname, IC,fill=fname)) +
geom_bar(stat = "identity", show.legend = FALSE) +
facet_wrap(~ date, ncol = 1,scales = "free") +
scale_x_discrete(labels = function(x) gsub("TMPxxx.+$", "", x))+
theme(axis.text.x=element_text(angle = 30))
```
     
     
沪深300因子IC表现如下图所示。
     
```{r,IC_week_hs300,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ic_week_all %>% filter(indexID=='EI000300') %>% group_by(date, fname) %>%  arrange(IC) %>% ungroup() %>%
  mutate(fname = factor(paste(fname, date, sep = "TMPxxx"), levels = rev(paste(fname,date, sep = "TMPxxx"))))

ggplot(tmp,aes(fname, IC,fill=fname)) +
geom_bar(stat = "identity", show.legend = FALSE) +
facet_wrap(~ date, ncol = 1,scales = "free") +
scale_x_discrete(labels = function(x) gsub("TMPxxx.+$", "", x))+
theme(axis.text.x=element_text(angle = 30))
```
     
    
中证500因子IC表现如下图所示。
     
```{r,IC_week_zz500,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ic_week_all %>% filter(indexID=='EI000905') %>% group_by(date, fname) %>%  arrange(IC) %>% ungroup() %>%
  mutate(fname = factor(paste(fname, date, sep = "TMPxxx"), levels = rev(paste(fname,date, sep = "TMPxxx"))))

ggplot(tmp,aes(fname, IC,fill=fname)) +
geom_bar(stat = "identity", show.legend = FALSE) +
facet_wrap(~ date, ncol = 1,scales = "free") +
scale_x_discrete(labels = function(x) gsub("TMPxxx.+$", "", x))+
theme(axis.text.x=element_text(angle = 30))
```     
    
     
因子IC统计如下表所示。
      
```{r,IC_week_summ_table,results='asis'}
kable(IC_week_summary_table)
```   


### (b)近一个月周频因子多空收益
在不同样本空间内，不同时间段，根据因子得分分为10组，得分最高的组收益率如下图所示，图上的标签标示该因子在这个样本空间内这个时间段的表现排名。
      
```{r,ngroup_week_all_Q1,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ngroup_week_all %>% filter(group=='Q1') %>% group_by(indexID,date) %>%  arrange(indexID,date,desc(return)) %>%
  mutate(rank = dense_rank(desc(return))) %>% ungroup() %>%
  mutate(fname = factor(fname, levels = fname[1:length(FactorLists)]))

ggplot(tmp,aes(fname, return,fill=indexID)) +
  geom_bar(stat = "identity",position = "dodge") +
  facet_wrap(~ date, ncol = 1,scales = "free") +
  theme(axis.text.x=element_text(angle = 30))+
  geom_text(aes(x=fname, y=return, label=rank), 
            position = position_dodge(width=1),size=3.5)
```
    
    
得分最最低的组收益率如下图所示。
    
     
```{r,ngroup_week_all_spread,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ngroup_week_all %>% filter(group=='Q10') %>% group_by(indexID,date) %>%  arrange(indexID,date,return) %>%
  mutate(rank = dense_rank(return)) %>% ungroup() %>%
  mutate(fname = factor(fname, levels = fname[1:length(FactorLists)]))

ggplot(tmp,aes(fname, return,fill=indexID)) +
  geom_bar(stat = "identity",position = "dodge") +
  facet_wrap(~ date, ncol = 1,scales = "free") +
  theme(axis.text.x=element_text(angle = 30))+
  geom_text(aes(x=fname, y=return, label=rank), 
            position = position_dodge(width=1),size=3.5)
```
     
    
      
因子的多空收益率如下图所示。
     
```{r,ngroup_week_hs300_Q1,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ngroup_week_all %>% filter(group=='Q1_Q10') %>% group_by(indexID,date) %>%  arrange(indexID,date,desc(return)) %>%
  mutate(rank = dense_rank(desc(return))) %>% ungroup() %>%
  mutate(fname = factor(fname, levels = fname[1:length(FactorLists)]))

ggplot(tmp,aes(fname, return,fill=indexID)) +
  geom_bar(stat = "identity",position = "dodge") +
  facet_wrap(~ date, ncol = 1,scales = "free") +
  theme(axis.text.x=element_text(angle = 30))+
  geom_text(aes(x=fname, y=return, label=rank), 
            position = position_dodge(width=1),size=3.5)
```
     
   
   
各个样本空间内，因子得分最高的一组和得分最低的一组的累积收益率统计如下表所示。
       
```{r,ngroup_week_summ_table,results='asis'}
kable(ngroup_week_all_sum)
```   



### (c)近一年月频因子IC
全市场因子IC表现如下图所示。
     
     
```{r,IC_month_all,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ic_month_all %>% filter(indexID=='EI000985') %>% group_by(date, fname) %>%  arrange(desc(IC)) %>% ungroup() %>%
  mutate(fname = factor(fname))

ggplot(tmp,aes(fname, IC,fill=fname)) +
geom_bar(stat = "identity") +
facet_wrap(~ date, ncol = 3) +
theme(axis.text.x=element_text(angle = 30))
```
     
     
沪深300因子IC表现如下图所示。
     
```{r,IC_month_hs300,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ic_month_all %>% filter(indexID=='EI000300') %>% group_by(date, fname) %>%  arrange(desc(IC)) %>% ungroup() %>%
  mutate(fname = factor(fname))

ggplot(tmp,aes(fname, IC,fill=fname)) +
geom_bar(stat = "identity") +
facet_wrap(~ date, ncol = 3) +
theme(axis.text.x=element_text(angle = 30))
```
     
    
中证500因子IC表现如下图所示。
     
```{r,IC_month_zz500,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ic_month_all %>% filter(indexID=='EI000905') %>% group_by(date, fname) %>%  arrange(desc(IC)) %>% ungroup() %>%
  mutate(fname = factor(fname))

ggplot(tmp,aes(fname, IC,fill=fname)) +
geom_bar(stat = "identity") +
facet_wrap(~ date, ncol = 3) +
theme(axis.text.x=element_text(angle = 30))
```     
    
     
因子IC统计如下表所示。
      
```{r,IC_month_summ_table,results='asis'}
kable(IC_month_summary_table)
```   




### (d)近一年月频因子多空收益
在不同样本空间内，不同时间段，根据因子得分分为10组，得分最高的组收益率如下图所示，图上的标签标示该因子在这个样本空间内这个时间段的表现排名。
      
```{r,ngroup_month_all_Q1,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ngroup_month_all %>% filter(indexID=='EI000985',group=='Q1') %>% group_by(date) %>%  arrange(date,desc(return)) %>% ungroup() %>%
  mutate(fname = factor(fname, levels = fname[1:length(FactorLists)]))

ggplot(tmp,aes(fname, return,fill=fname)) +
  geom_bar(stat = "identity",position = "dodge") +
  facet_wrap(~ date, ncol = 3) +
  theme(axis.text.x=element_text(angle = 30))
```
    
    
得分最最低的组收益率如下图所示。
    
     
```{r,ngroup_month_all_Q10,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ngroup_week_all %>% filter(group=='Q10') %>% group_by(indexID,date) %>%  arrange(indexID,date,return) %>%
  mutate(rank = dense_rank(return)) %>% ungroup() %>%
  mutate(fname = factor(fname, levels = fname[1:length(FactorLists)]))

ggplot(tmp,aes(fname, return,fill=indexID)) +
  geom_bar(stat = "identity",position = "dodge") +
  facet_wrap(~ date, ncol = 1,scales = "free") +
  theme(axis.text.x=element_text(angle = 30))+
  geom_text(aes(x=fname, y=return, label=rank), 
            position = position_dodge(width=1),size=3.5)
```
     
    
      
因子的多空收益率如下图所示。
     
```{r,ngroup_month_spread,warning=FALSE,fig.height=10,fig.width=10}
tmp <- ngroup_week_all %>% filter(group=='Q1_Q10') %>% group_by(indexID,date) %>%  arrange(indexID,date,desc(return)) %>%
  mutate(rank = dense_rank(desc(return))) %>% ungroup() %>%
  mutate(fname = factor(fname, levels = fname[1:length(FactorLists)]))

ggplot(tmp,aes(fname, return,fill=indexID)) +
  geom_bar(stat = "identity",position = "dodge") +
  facet_wrap(~ date, ncol = 1,scales = "free") +
  theme(axis.text.x=element_text(angle = 30))+
  geom_text(aes(x=fname, y=return, label=rank), 
            position = position_dodge(width=1),size=3.5)
```
     
   
   
各个样本空间内，因子得分最高的一组和得分最低的一组的累积收益率统计如下表所示。
       
```{r,ngroup_month_summ_table,results='asis'}
kable(ngroup_month_all_sum)
```   









```{r,savedata}
save(bond_yield,commodity_price,smallStockPort, smallStockRtn, file = "rptData.RData")
```


**************************************************************************
    
    
**************************************************************************

